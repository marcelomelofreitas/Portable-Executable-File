INF: formato de cabealho de arquivo executvel [P_WinSDK]

3,00
JANELAS 
PSSONLY | Notas sobre Desenvolvedores do Windows 3 softlib ENDUSER

Resumo:

Nota: Este artigo faz parte de um conjunto de sete artigos, coletivamente
chamado de "Windows 3.00 Developer's Notes". Mais informaoes sobre
o contedo dos outros artigos e os procedimentos para encomendar um
conjunto de cpias impressas, pode ser encontrado no artigo da base de conhecimento intitulado "INF:
Notas do desenvolvedor do Windows 3.00 "(Q65260).

Este artigo pode ser encontrado na Biblioteca de Software / Dados, pesquisando
a palavra EXEFMT ou S12688. EXEFMT foi arquivado usando o PKware
Utilitrio de compactaao de arquivos.

Mais Informaoes:

Microsoft definiu o formato de arquivo executvel segmentado para o Windows
aplicativos e bibliotecas de vnculo dinmico (DLLs). Este formato de arquivo 
tambm conhecido como o novo formato executvel. Este novo formato  um
extensao do formato exe do MS-DOS existente (formato antigo). o
A finalidade do formato executvel segmentado  fornecer
informaoes necessrias para apoiar a vinculaao dinmica e segmentaao
capacidades do ambiente Windows.

Um arquivo executvel contm cdigo e dados do Microsoft Windows ou
Cdigo, dados e recursos do Windows. Campos especficos foram adicionados a
o antigo cabealho do formato .EXE para indicar a existencia do
formato de arquivo segmentado. O cabealho de estilo antigo pode conter um
programa executvel, chamado programa stub, que ser executado se
o programa  executado no MS-DOS (sem o Windows). Este programa stub
geralmente imprime uma mensagem indicando que o Microsoft Windows  necessrio
para executar o programa. As extensoes de formato executvel segmentado tambm
comece com um cabealho que descreva o contedo e a localizaao do
imagem executvel no arquivo. O carregador usa essa informaao de cabealho
quando carrega os segmentos executveis ??na memria.


================================================== ====================
                     EXTENSOES DE CABEALHO DE ESTILO VELHO
================================================== ====================

O cabealho de estilo antigo contm informaoes que o carregador espera para um DOS
arquivo executvel. Descreve um programa stub (WINSTUB) que o carregador pode
lugar na memria quando necessrio, ele aponta para o novo cabealho de estilo e
contm a tabela de realocaao de programas stub.

O que se segue ilustra as partes distintas do estilo antigo
formato executvel:

        + ------------------------- +
    00h | Informaoes de cabealho de estilo antigo |
        + ------------------------- +
    20h | Reservado |
        + ------------------------- +
    3Ch | Deslocamento para segmentado |
        | .EXE cabealho |
        + ------------------------- +
    40h | Tabela de realocaao e |
        | Programa de stub do DOS |
        + ------------------------- +
        | Cabealho .exe segmentado |
        | . |
        | . |
        | . |

A palavra no deslocamento 18h no cabealho .exe estilo antigo contm o
deslocamento de byte relativo para a tabela de realocaao do programa stub. Se este
offset  40h, entao a palavra dupla no offset 3Ch  assumida como sendo a
deslocamento de byte relativo do comeo do arquivo ao incio
do cabealho executvel segmentado. Um arquivo .exe de novo formato 
identificado se o cabealho executvel segmentado contm um
assinatura. Se a assinatura nao for vlida, o arquivo ser considerado um
arquivo .exe de formato antigo. O restante do formato antigo
cabealho ir descrever um programa DOS, o stub. O esboo pode ser qualquer
programa vlido, mas normalmente ser um programa que exibe um erro
mensagem.

================================================== ====================
                         FORMATO EXE SEGMENTADO
================================================== ====================

Porque os arquivos executveis ??do Windows sao geralmente maiores que um segmento
(64K), informaoes adicionais (que nao aparecem no estilo antigo
cabealho)  necessrio para que o carregador possa carregar cada segmento adequadamente.
O formato EXE segmentado foi desenvolvido para fornecer ao carregador
em formaao.

O arquivo .exe segmentado tem o seguinte formato:

        + ----------------- +
    00h | EXE antigo |
        | Cabealho |
        + ----------------- +
    20h | Reservado |
        + ----------------- +
    3Ch | Deslocado para | --- +
        | Cabealho Segmentado | |
        + ----------------- + |
    40h | Tabela de Relocaao | |
        | Programa & Stub | |
        + ----------------- + |
        | | |
        + ----------------- + |
    xxh | EXE segmentado | <- +
        | Cabealho |
        + ----------------- +
        | Tabela de Segmentos |
        + ----------------- +
        | Tabela de Recursos |
        + ----------------- +
        | Nome Residente |
        | Tabela |
        + ----------------- +
        | Referencia do mdulo |
        | Tabela |
        + ----------------- +
        | Nomes Importados |
        | Tabela |
        + ----------------- +
        | Tabela de entrada |
        + ----------------- +
        | Nao-residente |
        | Tabela de nomes |
        + ----------------- +
        | Dados Seg # 1 |
        | Seg # 1 Info |
        + ----------------- +
                .
                .
                .
        + ----------------- +
        | Dados Seg #n |
        | Seg #n Info |
        + ----------------- +


As seoes a seguir descrevem cada um dos componentes que compoem
o formato EXE segmentado. Cada seao contm uma descriao do
componente e os campos nas estruturas que compoem que
componente.

Nota: Todos os campos e flag bits nao utilizados sao reservados para uso futuro e
deve conter 0 (zero) valores.

================================================== ====================
                         SUPORTE EXE SEGMENTADO
================================================== ====================

O cabealho EXE segmentado contm informaoes gerais sobre o EXE
arquivo e contm informaoes sobre a localizaao e tamanho da outra
Seoes. O carregador do Windows copia esta seao, junto com outros
dados, na tabela de mdulos nos dados do sistema. A tabela de mdulos 
dados internos usados ??pelo carregador para gerenciar o executvel carregado
mdulos no sistema e para suportar links dinmicos.

O seguinte descreve o formato do cabealho executvel segmentado.
Para cada campo, o deslocamento  dado em relaao ao incio do
cabealho segmentado, o tamanho do campo  definido e uma descriao
 dada.

    Descriao do tamanho do deslocamento
    ---------- -----------

    00h Palavra de assinatura DW.
                "N"  um byte de baixa ordem.
                "E"  um byte de alta ordem.

    02h DB Nmero da versao do linker.

    03h DB Nmero de revisao do linker.

    04h Desvio do arquivo de tabela de entrada DW, relativo ao incio de
                o cabealho de EXE segmentado.
    06h DW Nmero de bytes na tabela de entrada.

    08h DD CRC de 32 bits de todo o contedo do arquivo.
                Essas palavras sao consideradas como 00 durante o clculo.

    0Ch DW Flag word.
                0000h = NOAUTODATA
                0001h = SINGLEDATA (segmento de dados automtico compartilhado)
                0002h = MULTIPLEDATA (dados automticos instanciados
                        segmento)
                2000h = Erros detectados no momento do link, o mdulo nao
                        carga.
                8000h = mdulo de biblioteca.
                        A informaao SS: SP  invlida, CS: pontos IP
                        para um procedimento de inicializaao que  chamado
                        com AX igual ao manipulador do mdulo. este
                        procedimento de inicializaao deve executar um
                        retornar ao chamador, com AX diferente de
                        zero para indicar sucesso ou AX igual a zero
                        para indicar falha na inicializaao. DS est definido
                        para o segmento de dados da biblioteca se o
                        O flag SINGLEDATA est definido. Caso contrrio, o DS est definido
                        para o segmento de dados do chamador.

                        Um programa ou DLL s pode conter dinmica
                        links para arquivos executveis ??que tem este
                        conjunto de sinalizadores de mdulo de biblioteca. Um programa nao pode
                        link dinmico para outro programa.

    0Eh DW Nmero de segmento do segmento de dados automtico.
                Este valor  definido como zero se SINGLEDATA e
                Os bits de flag MULTIPLEDATA sao claros, NOAUTODATA 
                indicado na palavra bandeiras.

                Um nmero de segmento  um ndice no segmento do mdulo
                mesa. A primeira entrada na tabela de segmentos  segmento
                nmero 1.

    10h DW Tamanho inicial, em bytes, do heap dinmico adicionado ao
                segmento de dados. Este valor  zero se nenhum local inicial
                heap  alocado.

    12h DW Tamanho inicial, em bytes, da pilha adicionada aos dados
                segmento. Este valor  zero para indicar que nao h
                alocaao de pilha, ou quando SS nao  igual ao DS.

    14h DD Segmento: offset do CS: IP.

    18h DD Nmero de segmento: deslocamento de SS: SP.
                Se SS for igual ao segmento de dados automtico e SP for igual a
                zero, o ponteiro da pilha  colocado no topo da
                Segmento de dados automtico logo abaixo do heap adicional
                rea.

                    + -------------------------- +
                    | heap dinmico adicional |
                    + -------------------------- + <- SP
                    | pilha adicional |
                    + -------------------------- +
                    | segmento de dados automtico carregado |
                    + -------------------------- + <- DS, SS

    1Ch DW Nmero de entradas na tabela de segmentos.

    1Eh DW Nmero de entradas na Tabela de referencia do mdulo.
    20h DW Nmero de bytes na tabela de nomes nao residentes.

    22h Deslocamento do arquivo da tabela de segmentos DW, relativo ao incio
                do cabealho de EXE segmentado.

    24h DW Offset do arquivo de tabela de recursos, relativo ao incio
                do cabealho de EXE segmentado.

    26h Desvio do arquivo da tabela de nomes residentes DW, relativo a
                incio do cabealho de EXE segmentado.

    Deslocamento do arquivo Tabela de referencia do mdulo DW de 28 h, relativo a
                incio do cabealho de EXE segmentado.

    Deslocamento do arquivo da tabela de nomes importados 2Ah DW, relativo a
                incio do cabealho de EXE segmentado.

    2Ch DD Non-Resident Name Deslocamento da tabela, relativo ao
                incio do arquivo.

    30h DW Nmero de entradas mveis na tabela de entrada.

    32h DW Contagem de deslocamento de alinhamento do setor lgico, log (base 2) de
                o tamanho do setor do segmento (padrao 9).

    34h DW Nmero de entradas de recursos.

    36h Tipo de executvel do banco de dados, usado pelo carregador.
                  02h = JANELAS

    37h-3Fh DB Reservado, atualmente 0's.


================================================== ====================
                            TABELA DE SEGMENTO
================================================== ====================

A tabela de segmentos contm uma entrada para cada segmento no executvel
Arquivo. O nmero de entradas da tabela de segmentos  definido no segmento segmentado
Cabealho EXE. A primeira entrada na tabela de segmentos  o segmento nmero 1.
A seguir, a estrutura de uma entrada da tabela de segmentos.

   Tamanho Descriao
   ---- -----------

   DW Offset do setor lgico (n byte) para o contedo do segmento
        dados, relativos ao incio do arquivo. Zero significa que nao
        dados do arquivo.

   DW Comprimento do segmento no arquivo, em bytes. Zero significa 64K.

   Palavra de bandeira de DW.
        0007h = TYPE_MASK Campo do tipo de segmento.
        0000h = CODE Tipo de segmento de cdigo.
        0001h = Tipo de segmento de dados de dados.
        0010h = MOVEABLE O segmento nao  fixo.
        0040h = O segmento PRELOAD ser pr-carregado; somente leitura se
                           este  um segmento de dados.
        0100h = RELOCINFO Define se o segmento possui registros de realocaao.
        F000h = DESCARTE descartar a prioridade.

   DW Tamanho mnimo de alocaao do segmento, em bytes. Tamanho total
        do segmento. Zero significa 64K.


================================================== ====================
                            TABELA DE RECURSOS
================================================== ====================

A tabela de recursos segue a tabela de segmentos e contm entradas para
cada recurso no arquivo executvel. A tabela de recursos consiste em
uma contagem de deslocamento de alinhamento, seguida por uma tabela de registros de recursos. o
Os registros de recursos definem o ID do tipo para um conjunto de recursos. Cada
registro de recurso contm uma tabela de entradas de recursos do
tipo. A entrada do recurso define o ID do recurso ou o ID do nome para o
recurso. Tambm define a localizaao e o tamanho do recurso. o
A seguir descreve o contedo de cada uma dessas estruturas:

   Tamanho Descriao
   ---- -----------

   DW Contagem de deslocamento de alinhamento para dados de recursos.

   Uma tabela de blocos de informaoes do tipo de recurso  exibida a seguir. Os seguintes
    o formato de cada bloco de informaao de tipo:

        ID do tipo DW. Este  um tipo inteiro se o bit de alta ordem for
            conjunto (8000h); caso contrrio,  um deslocamento para a cadeia de tipos,
            o deslocamento  relativo ao incio do recurso
            mesa. Um ID de tipo zero marca o final do tipo de recurso
            blocos de informaao.

        DW Nmero de recursos para este tipo.

        DD reservado.

        Uma tabela de recursos para esse tipo segue. A seguir
        o formato de cada recurso (8 bytes cada):

            DW Desvio de arquivo para o contedo dos dados do recurso,
                em relaao ao incio do arquivo. O offset est em termos
                do valor da contagem de deslocamento de alinhamento especificado em
                incio da tabela de recursos.

            DW Comprimento do recurso no arquivo (em bytes).

            Palavra de bandeira de DW.
                0010h = MOVEABLE O recurso nao  fixo.
                0020h = O recurso PURE pode ser compartilhado.
                0040h = PRELOAD O recurso  pr-carregado.

            ID do recurso DW. Este  um tipo inteiro se a ordem alta
                bit  setado (8000h), senao  o offset para o
                cadeia de recursos, o deslocamento  relativo ao
                incio da tabela de recursos.

            DD reservado.

   As strings de tipo e nome de recurso sao armazenadas no final do
   tabela de recursos. Observe que essas cadeias NAO sao terminadas em nulo e
   diferenciam maisculas de minsculas.

   DB Comprimento do tipo ou cadeia de nomes que se segue. Um valor zero
        indica o final do tipo de recurso e da cadeia de nome, tambm
        o final da tabela de recursos.

   Texto DB ASCII do tipo ou cadeia de nome.


================================================== ====================
                         MESA DE NOME DO RESIDENTE
================================================== ====================

A tabela residente-nome segue a tabela de recursos e contm este
string de nome do mdulo e cadeias de nome de procedimento exportadas residentes. o
A primeira string nesta tabela  o nome deste mdulo. Essas cadeias de nome
sao sensveis a maisculas e minsculas e nao sao terminados em null. Os seguintes
descreve o formato das strings de nome:

   Tamanho Descriao
   ---- -----------

   Comprimento do DB da sequencia de nomes que segue. Um valor zero indica
        o final da tabela de nomes.

   Texto DB ASCII da cadeia de nomes.

   DW Nmero ordinal (ndice na tabela de entrada). Este valor  ignorado
        para o nome do mdulo.


================================================== ====================
                        TABELA DE REFERENCIA DE MDULO
================================================== ====================

A tabela de referencia de mdulo segue a tabela de nomes residentes. Cada entrada
contm um deslocamento para a string module-name dentro do importado
tabela de nomes; cada entrada tem 2 bytes de comprimento.

   Tamanho Descriao
   ---- -----------

   Deslocamento de DW dentro da tabela de nomes importados para o nome do mdulo referenciado
        corda.


================================================== ====================
                         TABELA DE NOMES IMPORTADOS
================================================== ====================

A tabela de nomes importados segue a tabela de referencia do mdulo. Essa mesa
contm os nomes dos mdulos e procedimentos que sao importados pelo
arquivo executvel. Cada entrada  composta por um campo de 1 byte
contm o tamanho da string, seguido por qualquer nmero de
personagens. As cadeias de caracteres nao sao terminadas por caractere nulo e sao
sensvel.

   Tamanho Descriao
   ---- -----------

   Comprimento do DB da sequencia de nomes que segue.

   Texto DB ASCII da cadeia de nomes.


================================================== ====================
                             TABELA DE ENTRADA
================================================== ====================

A tabela de entrada segue a tabela de nomes importados. Esta tabela contm
pacotes de definioes de ponto de entrada. Agrupamento  feito para economizar espao em
a tabela de entrada. A tabela de entrada  acessada por um valor ordinal.
O nmero um ordinal  definido para indexar a primeira entrada na entrada
mesa. Para encontrar um ponto de entrada, os pacotes sao verificados procurando
ponto de entrada especfico usando um nmero ordinal. O nmero ordinal 
ajustado conforme cada pacote  verificado. Quando o pacote que contm o
ponto de entrada  encontrado, o nmero ordinal  multiplicado pelo tamanho
as entradas do pacote para indexar a entrada apropriada.

O linker forma pacotes da forma mais densa que puder, sob o
restriao de que nao  possvel reordenar os pontos de entrada para melhorar o agrupamento.
O motivo dessa restriao  que outros arquivos .EXE podem se referir a
pontos de entrada dentro deste pacote pelo seu nmero ordinal. Os seguintes
descreve o formato dos pacotes da tabela de entrada.

   Tamanho Descriao
   ---- -----------

   DB Nmero de entradas neste pacote. Todos os registros em um pacote
        sao mveis ou se referem ao mesmo segmento fixo. Um zero
        valor neste campo indica o final da tabela de entrada.

   Indicador de segmento de banco de dados para este pacote. Isso define o tipo de
        dados de entrada da tabela de entrada no pacote. H tres
        tipos de entradas que sao definidas.

        000h = entradas nao utilizadas. Nao h dados de entrada em um nao utilizado
               agrupar. O prximo pacote segue este campo. Isto 
               usado pelo linker para pular nmeros ordinais.

        001h-0FEh = Nmero do segmento para entradas de segmento fixas. Uma fixa
               entrada do segmento  de 3 bytes de comprimento e tem o seguinte
               formato.

            Palavra de bandeira do banco de dados.
                01h = Defina se a entrada for exportada.
                02h = Defina se a entrada usa dados globais (compartilhados)
                      segmentos.
                      A primeira instruao de linguagem assembly no
                      ponto de entrada do prlogo deve ser "MOV AX, dados
                      nmero do segmento ". Isso pode ser definido apenas para
                      Mdulos da biblioteca SINGLEDATA.

            DW Deslocamento dentro do segmento para o ponto de entrada.

        0FFH = Entradas de segmento mveis. Os dados de entrada contm o
               nmero de segmento para os pontos de entrada. Um segmento mvel
               A entrada tem 6 bytes e tem o seguinte formato.

            Palavra de bandeira do banco de dados.
                01h = Defina se a entrada for exportada.
                02h = Defina se a entrada usa dados globais (compartilhados)
                      segmentos.

            INT 3FH.

            Nmero do segmento do banco de dados.

            DW Deslocamento dentro do segmento para o ponto de entrada.


================================================== ====================
                        TABELA DE NOME DO RESPONSVEL
================================================== ====================

A tabela de nomes nao residentes segue a tabela de entrada e contm uma
descriao do mdulo e seqencias de nomes de procedimento exportados nao residentes.
A primeira string nesta tabela  uma descriao do mdulo. Estes nome
seqencias de caracteres diferenciam maisculas de minsculas e nao sao terminadas por caractere nulo. O nome
strings seguem o mesmo formato daqueles definidos no nome do residente
mesa.


================================================== ====================
                           DADOS POR SEGMENTO
================================================== ====================

A localizaao eo tamanho dos dados por segmento sao definidos no
entrada de tabela de segmento para o segmento. Se o segmento tiver realocaao
fixups, conforme definido nos flags de entrada da tabela de segmento, eles
siga os dados do segmento no arquivo. As informaoes de correao de realocaao
 definido da seguinte forma:


   Tamanho Descriao
   ---- -----------

   DW Nmero de registros de relocaao que se seguem.

   Uma tabela de registros de realocaao segue. O seguinte  o formato
   de cada registro de relocaao.

        Tipo de origem do banco de dados.
            0Fh = SOURCE_MASK
            00h = LOBYTE
            02h = SEGMENTO
            03h = FAR_ADDR (ponteiro de 32 bits)
            05h = DESLOCAMENTO (deslocamento de 16 bits)

        DB Flags byte.
            03h = TARGET_MASK
            00h = INTERNALREF
            01h = IMPORTORDINAL
            02h = IMPORTNAME
            03h = OSFIXUP
            04h = ADITIVO

        Deslocamento de DW dentro deste segmento da cadeia de origem.
            Se o sinalizador ADDITIVE estiver definido, o valor de destino ser adicionado
            o contedo da fonte, em vez de substituir a fonte e
            seguindo a cadeia. A cadeia de origem  um 0FFFFh
            lista ligada terminada dentro deste segmento de todos
            referencias ao alvo.

        O valor de destino tem quatro tipos definidos no sinalizador
        campo byte. A seguir estao os formatos para cada destino
        tipo:

        INTERNALREF

            Nmero do segmento do banco de dados para um segmento fixo ou 0FFh para um
                segmento mvel.

            DB 0

            DW Offset into segment se segmento fixo ou ordinal
                ndice numrico na tabela de entrada se segmento mvel.

        IMPORTNAME

            DW Index na tabela de referencia do mdulo para o importado
                mdulo.

            Deslocamento de DW dentro da tabela de nomes importados para o nome do procedimento
                corda.

        IMPORTORDINAL

            DW Index na tabela de referencia do mdulo para o importado
                mdulo.
            DW Procedimento nmero ordinal.

        OSFIXUP

            Tipo de correao do sistema operacional DW.
                Correoes de ponto flutuante.
                0001h = FIARQQ, FJARQQ
                0002h = FISRQQ, FJSRQQ
                0003h = FICRQQ, FJCRQQ
                0004h = FIERQQ
                0005h = FIDRQQ
                0006h = FIWRQQ

            DW 0

================================================== ====================

Microsoft  uma marca registrada e Windows  uma marca comercial da
Corporaao Microsoft.

Outras palavras de referencia: 3,0